# Тестовое задание - Ozon Orders (JSON) 

В этом проекте реализован скрипт для парсинга Json-файла и загрузки данных из него.
В скрипте присутствует:
 - Проверка на дубли в бд и пропуск одинаковых записей при загрузке
 - Создание и проверка на существование для базы данных и таблицы, в которую будет осуществляться загрузка данных
 - Логирование каждого важного шага в файл `data_loader.log`
## Структура проекта

- `data_loader.py` - Скрипт для парсинг
- `ozon_orders.json` - Исходный файл с данными
- `.env` - Файл с настройкой переменных окружения (для конфиденциальности)
- `logs/` - Папка для записи логов выполнения `data_loader.py`
- `requirements.txt` - необходимые для работы проекта библиотеки Python

## Порядок запуска скрипта
Для начала работы скрипта достаточно запустить файл `data_loader.py`, но в случае если

1. Настройка переменных окружения: внесите свои авторизационные данные в файл `.env`
2. Проверьте название базы данных, таблицы и пути к файлу для загрузки в начале файла `data_loader.py`
   (JSON_FILE - путь к файлу, DB_NAME - название базы данных, table_name - название таблицы)
3. Запустите файл `data_loader.py`. При успешном выполнении скрипта вы увидите строчку "*Data successfully loaded into DB.*",
   в которой так же можно посмотреть сколько данных было загружено, а сколько пропущено

## Процесс выполнения программы

1. Инициализация переменных окружения, глобальных переменных
2. Настройка логирования (INFO, WARNING, ERROR, CRITICAL)
3. Подключение к базе данных
4. Проверка на существование базы данных, указанной в глобальной переменной `DB_NAME`
5. Проверка на существование таблицы, указанной в локальной переменной `table_name` в функции `is_table_exist`
6. Парсинг входного файла, проверка на валидность json
7. Построчное чтение входных данных: 
   1. Проверка строки на дубликаты
   2. Парсинг вложенной структуры
   3. Форматирование данных типа даты и времени
   3. Загрузка данных в таблицу
   4. Увеличение счетчиков загруженных и пропущенных записей
8. Сохранение результата в базе данных
9. Разрыв соединения с базой данных


## Реализация проверки на дубликаты
При загрузке данных в базу данных в проекте реализован механизм проверки на наличие дубля в базе:
1. При обработке каждой строчки отправляется запрос в базу данных на вывод строк содержащий значение поля `order_id` 
   имеющих такое же значение, что и у загружаемой строки. (Функция `is_duplicated`)
2. В случае если такое значение в базе найдено - текущая запись пропускается и не записывается в базу
3. Если же таких записей не было найдено, то текущая строчка загружaеться в базу

Благодаря итеративной загрузке этот случай так же учитывает наличие дублей во входном файле, т.к. загружает по одной записи.

## Логирование шагов

В скрипте логируются следующие процессы:
- Чтение переменных окружения из файла `.env`
- Подключение к базе данных
- Проверка на существование базы данных
- Проверка на существование таблицы
- Парсинг входного файла, проверка на валидность json
- Проверка строки на дубликаты
- Парсинг входного файла
- Загрузка данных в таблицу
- Форматирование данных типа даты и времени
- Разрыв соединения с базой данных

В основном на этих шагах логи уровня INFO,а так же реализована, ловящая ошибки, конструкция try - except 